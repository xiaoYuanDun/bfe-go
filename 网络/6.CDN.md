### DNS

因为 CDN 优化的是请求发出后, 报文在公共网络链路中的部分(我所知道的 CDN 实现也都是基于 DNS 的), 所以这里回顾一下 DNS 的解析过程

当我们访问一个诸如 `www.apple.com` 的域名时, 如果没有命中本地缓存的 DNS 关系记录(操作系统缓存/hosts 文件), 那么他会首先查询 **本地 DNS 服务**(我们使用的网络大部分都分属于各大网络运营商, 这里提到的 DNS 服务器就是他们自己搭建的 DNS 服务器), 如果命中缓存, 则直接返回对应的 IP 给客户端, 否则, 会向 **根 DNS 服务器** 发起请求, 从而得到 **顶级 DNS 服务器** 的地址(`.com` 所在 DNS 服务器的地址), 继续访问它, 得到下级域名服务器的地址(`.apple.com`) 的地址, 就这样, 直到解析完整的域名, 得到最终 的 IP 地址, 返回给客户端

而加入 CDN 服务后, 运营商会在自己搭建的 DNS 服务器中(上文提到过, 也是一般用户第一个访问的 DNS 服务) 添加 **CNAME** 记录值(**加速域名-GSLB 地址**), 当用户下一次访问这个加速域名时, 本地若存在就返回 IP 地址, 否则查找得出 CNAME, 接着通过 CNAME 找到 GSLB, 通过一系列算法, 得到对于当前请求地址来说最优的 CDN 边缘节点, 用户访问这个边缘节点 IP, 如果边缘节点存在缓存且缓存未失效就直接返回, 否则就去源站拉取资源, 缓存在边缘节点, 然后响应请求

这些操作, 因为是新增了一层网络架构, 所以对客户端来说, 是无感的

### CDN

普通的网络请求过程: client ---> DNS ---> server

加入 CDN 后: client ---> DNS ---> CDN-DNS ---> CDN 全局负载服务器 ---> 根据用户地址分配一个最优的 CDN 服务器 ------> server

CDN 实际上就是在物理层面上增加多个站点, 在每个站点上缓存目标资源(相当于在网络层与应用层新增了一层网络架构), 在请求到达时, 通过负载均衡等操作, 找到最优的(距离用户最近/访问速度最快)CDN 服务器, 从而避免主通路使用率过高, 访问距离远, 过程中横跨站点多等因素造成的访问速度降低的优化方式

### CDN 服务

填写 CDN 加速域名, 源站信息

源站域名会被指向加速域名, 再由加速域名提供 IP 地址, 然后在 DNS 商处为加速域名添加 CNAME

这样, 客户端直接访问加速域名, 就可以访问当源站内容了

理论上, 只有静态资源可以被缓存, 当访问资源是动态资源时(实时查询等), 会透传给源站

### 什么是 CNAME

`CNAME记录`, 即 记录值, 用来把一个域名转换为另一个域名, DNS 在得到一个 CNAME 记录 后, 会对 CNAME 指定的新域名进行解析(相当于域名转发),

### CDN 回源

当用户通过浏览器发送请求时，如果 CDN 节点未缓存请求的资源或缓存资源已到期，此时会回源站获取资源并返回给用户，该过程被称为回源

### CDN 节点(边缘节点) 配置

### 问题

#### 源站更新, CDN 如何做到同步更新资源

CDN 商一般还会提供 **刷新** 功能, 实际上就是将边缘节点中的指定内容删除, 这样下次再请求某个 CDN 节点时, 就可以强制触发回源, 保证这个节点的数据更新

#### 边缘节点未命中时, 如何回源, 一定会回源到源站吗

这个不一定, 看 CDN 具体物理架构,如果 CDN 上存在多级缓存, 会首先向上级缓存节点寻找资源, 如果在所有 CDN 网络中都没有找到资源, 那么回源

#### CDN 缓存时间对命中率的影响

如果 CDN 节点 缓存时间设置较短, 会降低缓存命中率, 降低访问速度, 加大源站访问压力

命中降低的因素还有:
刷新缓存：可能导致短时间内命中率下降。
CDN 节点访问新内容：导致 CDN 节点回源较多，命中率会表现有下降趋势。
缓存规则调整：可能会影响命中率。
没有参数过滤：如 `http://xxxxxx.com/movie/XSHD/res/ccb/ArrowScene.ccbi?_t=xxxxxxxxxxxxxx` 其中 t 只是一个事件标识, 但是由于 t 每次都不同, 导致无法命中之前的缓存

#### 其他功能

CDN 还可以把需要发布的资源提前分发到各 CDN 节点, 这就是 CDN 的预热功能, 避免新内容上线后, 短期内的回源剧增

### 参考资料, 待筛选

https://cloud.tencent.com/developer/article/1439913

https://juejin.cn/post/6844903460828086285

https://www.alibabacloud.com/help/zh/doc-detail/27101.htm?spm=a2c63.p38356.b99.6.29794befSReGAS

https://juejin.cn/post/6884033194308403208
